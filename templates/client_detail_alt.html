<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Details - WhatsApp Gateway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/ui/dashboard">WhatsApp Gateway</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/ui/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ui/clients">Clients</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Client Details: {{ .Client.ID }}</h1>
            <a href="/ui/clients" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Clients
            </a>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        Client Information
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h5>Status</h5>
                            {{ if eq .Client.Status "connected" }}
                                <span class="badge bg-success">Connected</span>
                            {{ else if eq .Client.Status "disconnected" }}
                                <span class="badge bg-warning text-dark">Disconnected</span>
                            {{ else if eq .Client.Status "logged_out" }}
                                <span class="badge bg-danger">Logged Out</span>
                            {{ else if eq .Client.Status "error" }}
                                <span class="badge bg-danger">Error</span>
                            {{ else }}
                                <span class="badge bg-secondary">{{ .Client.Status }}</span>
                            {{ end }}
                            
                            {{ if .Client.LoggedIn }}
                                <span class="badge bg-success">Authenticated</span>
                            {{ else }}
                                <span class="badge bg-danger">Not Authenticated</span>
                            {{ end }}
                            
                            {{ if eq $.DefaultClient .Client.ID }}
                                <span class="badge bg-primary">Default Client</span>
                            {{ end }}
                        </div>
                        
                        <div class="mb-3">
                            <h5>Details</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Client ID</th>
                                    <td>{{ .Client.ID }}</td>
                                </tr>
                                <tr>
                                    <th>Name</th>
                                    <td>{{ if .Client.PushName }}{{ .Client.PushName }}{{ else }}-{{ end }}</td>
                                </tr>
                                <tr>
                                    <th>Phone Number</th>
                                    <td>{{ if .Client.PhoneNumber }}{{ .Client.PhoneNumber }}{{ else }}-{{ end }}</td>
                                </tr>
                                <tr>
                                    <th>Last Activity</th>
                                    <td>{{ .Client.LastActivity.Format "2006-01-02 15:04:05" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        Actions
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            {{ if not .Client.LoggedIn }}
                                <a href="/ui/qrcode/{{ .Client.ID }}" class="btn btn-success">
                                    <i class="bi bi-qr-code"></i> QR Code Authentication
                                </a>
                            {{ else }}
                                <a href="/ui/sendmessage/{{ .Client.ID }}" class="btn btn-primary">
                                    <i class="bi bi-chat-dots"></i> Send Message
                                </a>
                                <button id="logout-btn" class="btn btn-danger">
                                    <i class="bi bi-box-arrow-right"></i> Logout from WhatsApp
                                </button>
                            {{ end }}
                            
                            {{ if not .Client.IsDefault }}
                                <button id="set-default-btn" class="btn btn-warning">
                                    <i class="bi bi-star"></i> Set as Default Client
                                </button>
                            {{ end }}
                            
                            <button id="delete-btn" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i> Delete Client
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        Connection Status
                    </div>
                    <div class="card-body">
                        <div id="status-container">
                            <p>
                                <strong>Connection:</strong>
                                {{ if eq .Client.Status "connected" }}
                                    <span class="text-success">Connected</span>
                                {{ else }}
                                    <span class="text-danger">Disconnected</span>
                                {{ end }}
                            </p>
                            
                            <p>
                                <strong>Authentication:</strong>
                                {{ if .Client.LoggedIn }}
                                    <span class="text-success">Authenticated</span>
                                {{ else }}
                                    <span class="text-danger">Not Authenticated</span>
                                {{ end }}
                            </p>
                            
                            <div class="d-grid mt-3">
                                <button id="refresh-status-btn" class="btn btn-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmation-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    Are you sure you want to proceed with this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-5 py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">Go Simple WhatsApp Gateway</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="/static/js/main.js"></script>
    
    <!-- Debug indicator for troubleshooting -->
    <div id="js-debug" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; z-index: 9999;">
        JS Running | Template: client_detail_alt.html
    </div>
    
    <script>
        $(document).ready(function() {
            const clientId = "{{ .Client.ID }}";
            let confirmAction = null;
            
            // Refresh status button
            $('#refresh-status-btn').on('click', function() {
                refreshStatus();
            });
            
            // Set as default client
            $('#set-default-btn').on('click', function() {
                showConfirmation(
                    'Set Default Client',
                    `Are you sure you want to set "${clientId}" as the default client?`,
                    'btn-warning',
                    setDefaultClient
                );
            });
            
            // Logout button
            $('#logout-btn').on('click', function() {
                showConfirmation(
                    'Logout Confirmation',
                    `Are you sure you want to log out of WhatsApp on client "${clientId}"?`,
                    'btn-danger',
                    logoutClient
                );
            });
            
            // Delete client button
            $('#delete-btn').on('click', function() {
                showConfirmation(
                    'Delete Client',
                    `Are you sure you want to delete client "${clientId}"? This action cannot be undone.`,
                    'btn-danger',
                    deleteClient
                );
            });
            
            // Confirm button click
            $('#confirm-btn').on('click', function() {
                if (typeof confirmAction === 'function') {
                    confirmAction();
                }
                $('#confirmation-modal').modal('hide');
            });
            
            // Show confirmation modal
            function showConfirmation(title, message, btnClass, callback) {
                $('#modal-title').text(title);
                $('#modal-body').text(message);
                $('#confirm-btn').removeClass('btn-primary btn-danger btn-warning').addClass(btnClass);
                confirmAction = callback;
                $('#confirmation-modal').modal('show');
            }
            
            // Refresh client status
            function refreshStatus() {
                $.ajax({
                    url: '/api/clients/' + clientId,
                    method: 'GET',
                    headers: {
                        'X-API-Key': getApiKey()
                    },
                    success: function(response) {
                        // Reload the page to show updated status
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error refreshing status: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    }
                });
            }
            
            // Set as default client
            function setDefaultClient() {
                $.ajax({
                    url: '/api/clients/default',
                    method: 'POST',
                    headers: {
                        'X-API-Key': getApiKey()
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ id: clientId }),
                    success: function() {
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error setting default client: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    }
                });
            }
            
            // Logout client
            function logoutClient() {
                $.ajax({
                    url: '/api/clients/' + clientId + '/logout',
                    method: 'POST',
                    headers: {
                        'X-API-Key': getApiKey()
                    },
                    success: function() {
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Error logging out: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    }
                });
            }
            
            // Delete client
            function deleteClient() {
                $.ajax({
                    url: '/api/clients/' + clientId,
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': getApiKey()
                    },
                    success: function() {
                        window.location.href = '/ui/clients';
                    },
                    error: function(xhr) {
                        alert('Error deleting client: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    }
                });
            }
        });
    </script>
</body>
</html>